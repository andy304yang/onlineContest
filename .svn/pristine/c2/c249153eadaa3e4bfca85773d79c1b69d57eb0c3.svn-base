<template>
  <div class="app-container">
    <!-- 表格顶部功能框 -->
    <div class="filter-container">
      <!-- 功能框分为三部分 -->
      <div class="flex-box">
        <div class="filter-item">
          <el-button
            v-show="activeName === 'all'"
            type="primary"
            icon="el-icon-download"
            @click="handleBale"
          >
            下载全部作品资源
          </el-button>
          <el-button
            v-show="activeName === 'all' && operability"
            type="primary"
            icon="el-icon-edit"
            @click="enterFin"
          >
            批量进入决赛
          </el-button>
        </div>
        <div>
          <el-select v-model="checkedSearch" class="filter-item" style="width: 130px">
            <el-option
              v-for="item in searchOptions"
              :key="item.key"
              :label="item.display_name"
              :value="item.key"
            />
          </el-select>
          <el-input v-model="searchKey" clearable placeholder="请输入关键字" style="width: 300px;" class="filter-item" @keyup.enter.native="handleFilter" @clear="handleClear" />
          <el-button v-waves class="filter-item" type="primary" icon="el-icon-search" @click="handleFilter">
            搜索
          </el-button>
        </div>
        <el-button v-waves :loading="downloadLoading" class="filter-item" type="primary" icon="el-icon-download" @click="Download">
          <a :href="excelAdress">导出Excel</a>
        </el-button>
      </div>
    </div>
    <!-- 协会管理员 -->
    <el-tabs v-if="isClubAdmin" v-model="activeName" @tab-click="tabClick">
      <el-tab-pane label="已退回作品" name="back">
        <back
          v-if="activeName === 'back'"
          ref="back"
          :list-query="listQuery"
          :is-club-admin="isClubAdmin"
          @handleWork="popWorkDetails"
        />
      </el-tab-pane>
      <el-tab-pane label="待审核作品" name="check">
        <checking
          v-if="activeName === 'check'"
          ref="check"
          :list-query="listQuery"
          :is-club-admin="isClubAdmin"
          @handleWork="popWorkDetails"
        />
      </el-tab-pane>
      <el-tab-pane label="已审核作品" name="distribute">
        <distribute
          v-if="activeName === 'distribute'"
          ref="distribute"
          :list-query="listQuery"
          :is-club-admin="isClubAdmin"
          @handleWork="popWorkDetails"
        />
      </el-tab-pane>
    </el-tabs>
    <!-- 其他 -->
    <el-tabs v-else v-model="activeName" @tab-click="tabClick">
      <el-tab-pane label="全部作品" name="all">
        <reviewed v-if="activeName === 'all'" ref="all" :list-query="listQuery" @handleWork="popWorkDetails" @downExcel="downExcel" />
      </el-tab-pane>
      <el-tab-pane label="高度相似作品" name="similar">
        <similar v-if="activeName === 'similar'" ref="similar" :list-query="listQuery" @handleWork="popWorkDetails" />
      </el-tab-pane>
      <el-tab-pane label="已退回作品" name="back">
        <back v-if="activeName === 'back'" ref="back" :list-query="listQuery" @handleWork="popWorkDetails" />
      </el-tab-pane>
      <el-tab-pane label="待审核作品" name="check">
        <checking v-if="activeName === 'check'" ref="check" :list-query="listQuery" @handleWork="popWorkDetails" />
      </el-tab-pane>
      <el-tab-pane label="待分配作品" name="distribute">
        <distribute v-if="activeName === 'distribute'" ref="distribute" :list-query="listQuery" @handleWork="popWorkDetails" />
      </el-tab-pane>
      <el-tab-pane label="未得分作品" name="noscored">
        <noscored v-if="activeName === 'noscored'" ref="noscored" :list-query="listQuery" @handleWork="popWorkDetails" />
      </el-tab-pane>
      <el-tab-pane label="已得分作品" name="scored">
        <scored v-if="activeName === 'scored'" ref="scored" :list-query="listQuery" @handleWork="popWorkDetails" />
      </el-tab-pane>
      <el-tab-pane label="未出线作品" name="unrise">
        <unrise v-if="activeName === 'unrise'" ref="unrise" :list-query="listQuery" @handleWork="popWorkDetails" />
      </el-tab-pane>
      <el-tab-pane label="已出线作品" name="rise">
        <rise v-if="activeName === 'rise'" ref="rise" :list-query="listQuery" @handleWork="popWorkDetails" />
      </el-tab-pane>
      <el-tab-pane label="决赛作品" name="final">
        <final v-if="activeName === 'final'" ref="final" :list-query="listQuery" @handleWork="popWorkDetails" />
      </el-tab-pane>
    </el-tabs>
    <!-- 弹出作品框 -->
    <works-details ref="details" />
  </div>
</template>

<script>
import { downAllWork } from '@/api/Competition/works/all'
import { mapGetters } from 'vuex'
import waves from '@/directive/waves'
import Reviewed from './components/Reviewed'
import Checking from './components/Checking'
import Similar from './components/Similar'
import Distribute from './components/Distribute'
import Back from './components/Back'
import Noscored from './components/Noscored'
import Scored from './components/Scored'
import Rise from './components/Rise'
import Unrise from './components/Unrise'
import Final from './components/Final'
import WorksDetails from '@/components/Acomponents/WorksDetails'

export default {
  name: 'Enroll',
  components: { Reviewed, Similar, Checking, Distribute, WorksDetails, Back, Noscored, Scored, Unrise, Rise, Final },
  directives: { waves },
  data() {
    return {
      workUrl: '',
      activeName: '',
      tableKey: 0,
      list: null,
      total: 0,
      checkedSearch: 'type',
      searchOptions: [
        { key: 'type', display_name: '竞赛类别' },
        { key: 'match_name', display_name: '竞赛名称' },
        { key: 'work_name', display_name: '作品名称' },
        { key: 'author1_name', display_name: '负责人' },
        { key: 'teacher', display_name: '指导老师' }
      ],
      searchKey: '',
      listQuery: {
        page: 1,
        limit: 20,
        match_name: '',
        match_project: '',
        work_name: '',
        type: '',
        teamname: '',
        teacher: '',
        author1_name: '',
        normalization: 0
      },
      downloadLoading: false,
      excelAdressTemp: '',
      excelAdress: '',
      flag: {
        similar: -2,
        back: -1,
        check: 0,
        distribute: 1,
        noscored: 2,
        scored: 3,
        unrise: 4,
        rise: 5,
        final: 6
        // -1: 退回作品列表
        // 0：待审核列表
        // 1：已筛选列表
        // 5：出线作品列表
        // 6：决赛作品列表
      }
    }
  },
  computed: {
    ...mapGetters([
      'roles'
    ]),
    ...mapGetters([
      'operability'
    ]),
    isClubAdmin() {
      return this.roles.includes('clubAdmin')
    }
  },
  watch: {
    activeName(val) {
      this.$router.push(`${this.$route.path}?tab=${val}`)
    }
  },
  created() {
    const tab = this.$route.query.tab
    if (tab) {
      this.activeName = tab
    } else {
      this.activeName = this.isClubAdmin ? 'back' : 'all'
    }
    this.listQuery.normalization = this.flag[this.activeName]
  },
  methods: {
    reset() {
      this.listQuery = {
        page: 1,
        limit: 20,
        teacher: '',
        match_name: '',
        match_project: '',
        work_name: '',
        type: '',
        teamname: '',
        author1_name: '',
        normalization: this.flag[this.activeName]
      }
    },
    handleFilter() {
      if (this.activeName !== 'all') {
        this.reset()
        this.listQuery[this.checkedSearch] = this.searchKey
        this.$refs[this.activeName].getList(this.checkedSearch, this.searchKey)
      } else {
        this.reset()
        this.listQuery[this.checkedSearch] = this.searchKey
        this.$refs.all.search(this.listQuery)
      }
    },
    handleClear() {
      this.reset()
      this.$refs[this.activeName].getList(this.checkedSearch, this.searchKey)
    },
    // 父组件弹出子组件作品详情弹框
    popWorkDetails(wid) {
      this.$refs.details.popWorkDetails(wid)
    },
    // 打包全部文件
    handleBale() {
      downAllWork().then(response => {
        window.location.href = response.obj
        this.$notify({
          title: '成功',
          message: '文件打包成功',
          type: 'success',
          duration: 2000
        })
      })
    },
    // 下载excel
    Download() {
      if (this.activeName === 'first') {
        this.downloadLoading = true
        this.excelAdress = this.excelAdressTemp
        this.downloadLoading = false
      } else if (this.activeName === 'second') {
        this.downloadLoading = true
        this.$refs.all.handleDownload()
        this.downloadLoading = false
      } else if (this.activeName === 'third') {
        this.downloadLoading = true
        this.$refs.similar.handleDownload()
        this.downloadLoading = false
      } else if (this.activeName === 'fourth') {
        this.downloadLoading = true
        this.$refs.alall.handleDownload()
        this.downloadLoading = false
      } else {
        this.downloadLoading = true
        this.$refs.return.handleDownload()
        this.downloadLoading = false
      }
    },
    downExcel(excel) {
      this.excelAdressTemp = excel
    },
    enterFin() {
      if (this.$refs.rev.checkedWorks.length === 0) {
        this.$notify({
          title: '您要选择哪些作品呢？',
          message: '请勾选作品',
          type: 'warning',
          duration: 2000
        })
      } else {
        this.$refs.rev.handleFin()
      }
    },
    // 切换标签页恢复检索为空
    tabClick(a) {
      this.reset()
      this.searchKey = ''
    }
  }
}
</script>
<style scoped>
  .flex-box {
    display: flex;
    justify-content: space-between;
  }
</style>

